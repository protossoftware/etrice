/**
 * @author generated by eTrice
 *
 * Source File of SubSystemClass SubSys
 * 
 */

#include "Node1.h"

/* include instances for all classes */
#include "Node1_Inst.h"
#include "Node1_Disp.h"

#include "debugging/etLogger.h"
#include "debugging/etMSCLogger.h"

#include "platform/etTimer.h"
#include "etRuntimeConfig.h"
#include "messaging/etMessageService.h"

/* data for Node1 */
typedef struct Node1 {
	char *name;
	volatile int shutdownRequest;
} Node1;

static Node1 Node1Inst = {"Node1",0};

void Node1_initActorInstances(void);
void Node1_constructActorInstances(void);


void Node1_initMessageServices(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "initMessageServices")

	/* filling all message service threads with data */
	/*PhysicalThread1*/
	// TODO: gen
	msgService_PhysicalThread1.thread.stacksize = 1024;
	msgService_PhysicalThread1.thread.priority = 0;
	msgService_PhysicalThread1.thread.threadName = "PhysicalThread1";
	msgService_PhysicalThread1.thread.threadFunction = (etThreadFunction) etMessageService_execute;
	msgService_PhysicalThread1.thread.threadFunctionData = &msgService_PhysicalThread1;


	/*PhysicalThread2*/
	// TODO: gen
	msgService_PhysicalThread2.thread.stacksize = 1024;
	msgService_PhysicalThread2.thread.priority = 0;
	msgService_PhysicalThread2.thread.threadName = "PhysicalThread2";
	msgService_PhysicalThread2.thread.threadFunction = (etThreadFunction) etMessageService_execute;
	msgService_PhysicalThread2.thread.threadFunctionData = &msgService_PhysicalThread2;
	
	/* initialization of all message services */
	etMessageService_init(&msgService_PhysicalThread1, msgBuffer_PhysicalThread1, MESSAGE_POOL_MAX, MESSAGE_BLOCK_SIZE, MsgDispatcher_PhysicalThread1_receiveMessage);
	etMessageService_init(&msgService_PhysicalThread2, msgBuffer_PhysicalThread2, MESSAGE_POOL_MAX, MESSAGE_BLOCK_SIZE, MsgDispatcher_PhysicalThread2_receiveMessage);

	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_startMessageServices(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "startMessageServices")

	etMessageService_start(&msgService_PhysicalThread1);
	etMessageService_start(&msgService_PhysicalThread2);

	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_stopMessageServices(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "stopMessageServices")

	etMessageService_stop(&msgService_PhysicalThread1);
	etMessageService_stop(&msgService_PhysicalThread2);

	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_destroyMessageServices(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "destroyMessageServices")

	etMessageService_destroy(&msgService_PhysicalThread1);
	etMessageService_destroy(&msgService_PhysicalThread2);

	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_init(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "init")
	etLogger_logInfoF("%s_init", Node1Inst.name);

	/* construct all actors */
	Node1_constructActorInstances();

	Node1_initMessageServices();

	/* init all actors */
	Node1_initActorInstances();
	
	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_start(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "start")
	etLogger_logInfoF("%s_start", Node1Inst.name);
	Node1_startMessageServices();
	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_run(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "run")
	
	etThread_sleep(1000);

//	#ifdef ET_RUNTIME_ENDLESS
//		while(!(Node1Inst.shutdownRequest)){
//			if (etTimer_executeNeeded()){
//				etMessageService_execute(&msgService_PhysicalThread1);
//			}
//		}
//	#else
//		uint32 loopCounter = 0;
//		while(!(Node1Inst.shutdownRequest)){
//			if (etTimer_executeNeeded()){
//				etMessageService_execute(&msgService_PhysicalThread1);
//				etLogger_logInfo("Execute");
//				if (loopCounter++ > ET_RUNTIME_MAXLOOP){
//					break;
//				}
//			}
//		}
//	#endif
	
	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_stop(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "stop")
	etLogger_logInfoF("%s_stop", Node1Inst.name);
	Node1_stopMessageServices();
	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_destroy(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "destroy")
	etLogger_logInfoF("%s_destroy", Node1Inst.name);
	Node1_destroyMessageServices();
	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_shutdown(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "shutdown")
	etLogger_logInfoF("%s_shutdown", Node1Inst.name);
	Node1Inst.shutdownRequest = 1;
	ET_MSC_LOGGER_SYNC_EXIT
}


void Node1_constructActorInstances(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "constructActorInstances")
	ET_MSC_LOGGER_SYNC_EXIT
}

void Node1_initActorInstances(void){
	ET_MSC_LOGGER_SYNC_ENTRY("Node1", "initActorInstances")
	Sender_init(&_SubSys_Sender);
	Receiver_init(&_SubSys_Receiver);
	ET_MSC_LOGGER_SYNC_EXIT
}

